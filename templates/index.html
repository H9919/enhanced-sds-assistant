<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                                <select id="uploadDepartmentSelect" name="department" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                    <option value="">Choose a department...</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
                                <select id="uploadStateSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                    <option value="">Choose a state...</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">City</label>
                                <select id="uploadCitySelect" name="city" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                    <option value="">Choose a city...</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Country</label>
                                <select name="country" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                    <option value="United States">United States</option>
                                    <option value="Canada">Canada</option>
                                    <option value="Mexico">Mexico</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">SDS File</label>
                            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg hover:border-gray-400 transition">
                                <div class="space-y-1 text-center">
                                    <i class="fas fa-cloud-upload-alt text-3xl text-gray-400"></i>
                                    <div class="flex text-sm text-gray-600">
                                        <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500">
                                            <span>Upload a file</span>
                                            <input id="file-upload" name="file" type="file" class="sr-only" accept=".pdf,.txt,.doc,.docx" required>
                                        </label>
                                        <p class="pl-1">or drag and drop</p>
                                    </div>
                                    <p class="text-xs text-gray-500">PDF, TXT, DOC up to 50MB</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button type="button" id="cancelUpload" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">
                                Cancel
                            </button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                <i class="fas fa-upload mr-2"></i>Upload
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Web Search Modal -->
    <div id="webSearchModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-lg w-full">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-900">Manual Web Search for SDS</h3>
                        <button id="closeWebSearchModal" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                        <p class="text-sm text-blue-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>Auto Search:</strong> The AI automatically searches online when you ask questions. Use this for manual searches of specific chemicals.
                        </p>
                    </div>
                    
                    <form id="webSearchForm">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Chemical/Product Name</label>
                            <input type="text" id="searchChemicalName" name="chemical_name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., Acetone, Bleach, Isopropyl Alcohol" required>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                                <select id="searchDepartmentSelect" name="department" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                    <option value="">Choose department...</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">City</label>
                                <select id="searchCitySelect" name="city" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                    <option value="">Choose city...</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
                                <select id="searchStateSelect" name="state" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                    <option value="">Choose state...</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button type="button" id="cancelWebSearch" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">
                                Cancel
                            </button>
                            <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                                <i class="fas fa-search mr-2"></i>Search & Download
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Label Generation Modal -->
    <div id="labelModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-900">Generate Safety Labels</h3>
                        <button id="closeLabelModal" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Product Name</label>
                        <input type="text" id="labelProductName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Enter product name (e.g., Acetone, Bleach)">
                        <p class="text-xs text-gray-500 mt-1">Enter the name of a chemical you've uploaded or searched for</p>
                    </div>
                    
                    <!-- Label Type Selection -->
                    <div class="mb-6">
                        <h4 class="font-semibold text-gray-700 mb-3">Choose Label Type:</h4>
                        <div class="grid grid-cols-1 gap-3">
                            <button id="generateNFPA" type="button" class="flex items-center p-4 border-2 border-red-200 rounded-lg hover:border-red-400 hover:bg-red-50 transition">
                                <div class="p-2 bg-red-100 rounded-full mr-3">
                                    <i class="fas fa-diamond text-red-600 text-lg"></i>
                                </div>
                                <div class="text-left">
                                    <h5 class="font-semibold text-red-600">NFPA 704 Diamond</h5>
                                    <p class="text-sm text-gray-600">Standard fire diamond with hazard ratings</p>
                                </div>
                            </button>
                            
                            <button id="generateGHS" type="button" class="flex items-center p-4 border-2 border-orange-200 rounded-lg hover:border-orange-400 hover:bg-orange-50 transition">
                                <div class="p-2 bg-orange-100 rounded-full mr-3">
                                    <i class="fas fa-exclamation-triangle text-orange-600 text-lg"></i>
                                </div>
                                <div class="text-left">
                                    <h5 class="font-semibold text-orange-600">GHS Hazard Label</h5>
                                    <p class="text-sm text-gray-600">Globally harmonized system label</p>
                                </div>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancelLabel" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" class="fixed top-4 right-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg border-l-4 p-4 max-w-sm">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i id="toastIcon" class="text-xl"></i>
                </div>
                <div class="ml-3">
                    <p id="toastMessage" class="text-sm font-medium text-gray-900"></p>
                </div>
                <div class="ml-auto pl-3">
                    <button id="closeToast" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentConversation = [];
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardStats();
            loadDepartments();
            loadStates();
            loadRecentDocuments();
            setupEventListeners();
        });
        
        // Setup enhanced event listeners
        function setupEventListeners() {
            // Question answering
            document.getElementById('askBtn').addEventListener('click', askQuestion);
            document.getElementById('questionInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') askQuestion();
            });
            
            // Quick questions
            document.querySelectorAll('.quick-question').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.getElementById('questionInput').value = this.dataset.question;
                    askQuestion();
                });
            });
            
            // File upload
            document.getElementById('uploadBtn').addEventListener('click', () => showModal('uploadModal'));
            document.getElementById('uploadDocBtn').addEventListener('click', () => showModal('uploadModal'));
            document.getElementById('closeUploadModal').addEventListener('click', () => hideModal('uploadModal'));
            document.getElementById('cancelUpload').addEventListener('click', () => hideModal('uploadModal'));
            document.getElementById('uploadForm').addEventListener('submit', handleFileUpload);
            
            // Web search
            document.getElementById('webSearchBtn').addEventListener('click', () => showModal('webSearchModal'));
            document.getElementById('webSearchDocBtn').addEventListener('click', () => showModal('webSearchModal'));
            document.getElementById('closeWebSearchModal').addEventListener('click', () => hideModal('webSearchModal'));
            document.getElementById('cancelWebSearch').addEventListener('click', () => hideModal('webSearchModal'));
            document.getElementById('webSearchForm').addEventListener('submit', handleWebSearch);
            
            // Label generation
            document.getElementById('generateLabelBtn').addEventListener('click', () => showModal('labelModal'));
            document.getElementById('generateLabelsBtn').addEventListener('click', () => showModal('labelModal'));
            document.getElementById('closeLabelModal').addEventListener('click', () => hideModal('labelModal'));
            document.getElementById('cancelLabel').addEventListener('click', () => hideModal('labelModal'));
            document.getElementById('generateNFPA').addEventListener('click', () => generateLabel('nfpa'));
            document.getElementById('generateGHS').addEventListener('click', () => generateLabel('ghs'));
            
            // Enhanced dropdowns
            document.getElementById('uploadStateSelect').addEventListener('change', function() {
                loadCitiesByState(this.value, 'uploadCitySelect');
            });
            
            document.getElementById('searchStateSelect').addEventListener('change', function() {
                loadCitiesByState(this.value, 'searchCitySelect');
            });
            
            document.getElementById('stateFilter').addEventListener('change', updateLocationFilters);
            
            // Toast close
            document.getElementById('closeToast').addEventListener('click', hideToast);
        }
        
        // Load enhanced dashboard statistics
        async function loadDashboardStats() {
            try {
                const response = await fetch('/api/dashboard-stats');
                const stats = await response.json();
                
                document.getElementById('totalDocs').textContent = stats.total_documents;
                document.getElementById('activeLocations').textContent = stats.active_locations;
                document.getElementById('recentQuestions').textContent = stats.recent_questions;
                document.getElementById('hazardousMaterials').textContent = stats.hazardous_materials;
                document.getElementById('webSearches').textContent = stats.web_searches_performed || 0;
                
                updatePopularQuestions(stats.popular_questions);
                updateTopDepartments(stats.top_departments);
                
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }
        
        // Load departments
        async function loadDepartments() {
            try {
                const response = await fetch('/api/departments');
                const departments = await response.json();
                
                const selects = ['uploadDepartmentSelect', 'searchDepartmentSelect', 'departmentFilter'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        departments.forEach(dept => {
                            const option = document.createElement('option');
                            option.value = dept.name;
                            option.textContent = dept.name;
                            select.appendChild(option);
                        });
                    }
                });
                
            } catch (error) {
                console.error('Error loading departments:', error);
            }
        }
        
        // Load states
        async function loadStates() {
            try {
                const response = await fetch('/api/states');
                const states = await response.json();
                
                const selects = ['uploadStateSelect', 'searchStateSelect', 'stateFilter'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        states.forEach(state => {
                            const option = document.createElement('option');
                            option.value = state;
                            option.textContent = state;
                            select.appendChild(option);
                        });
                    }
                });
                
            } catch (error) {
                console.error('Error loading states:', error);
            }
        }
        
        // Load cities by state
        async function loadCitiesByState(state, selectId) {
            if (!state) {
                document.getElementById(selectId).innerHTML = '<option value="">Choose a city...</option>';
                return;
            }
            
            try {
                const response = await fetch(`/api/cities?state=${encodeURIComponent(state)}`);
                const cities = await response.json();
                
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Choose a city...</option>';
                
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading cities:', error);
            }
        }
        
        // Load recent documents
        async function loadRecentDocuments() {
            try {
                const response = await fetch('/api/recent-documents');
                const documents = await response.json();
                
                const container = document.getElementById('recentDocumentsList');
                container.innerHTML = '';
                
                if (documents.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">No documents uploaded yet</p>';
                    return;
                }
                
                documents.forEach(doc => {
                    const div = document.createElement('div');
                    div.className = 'p-3 border rounded-lg hover:bg-gray-50 transition cursor-pointer';
                    div.innerHTML = `
                        <h4 class="font-medium text-sm">${doc.product_name}</h4>
                        <p class="text-xs text-gray-500">${doc.location}</p>
                        <div class="flex justify-between items-center mt-1">
                            <p class="text-xs text-gray-400">${new Date(doc.uploaded_date).toLocaleDateString()}</p>
                            <span class="text-xs">${doc.source}</span>
                        </div>
                    `;
                    div.addEventListener('click', () => {
                    document.getElementById('questionInput').value = q.question;
                    askQuestion();
                });
                container.appendChild(div);
            });
        }
        
        // Update top departments display
        function updateTopDepartments(departments) {
            const container = document.getElementById('topDepartments');
            container.innerHTML = '';
            
            if (departments.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No data available yet</p>';
                return;
            }
            
            departments.forEach(dept => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <div>
                        <p class="text-sm font-medium">${dept.department}</p>
                        <p class="text-xs text-gray-500">${dept.count} documents</p>
                    </div>
                    <div class="w-16 bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full" style="width: ${Math.min(100, (dept.count / departments[0].count) * 100)}%"></div>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        // Modal utilities
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            
            // Load data when showing modals
            if (modalId === 'uploadModal' || modalId === 'webSearchModal') {
                loadDepartments();
                loadStates();
            }
        }
        
        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            
            // Reset forms when hiding modals
            const modal = document.getElementById(modalId);
            const forms = modal.querySelectorAll('form');
            forms.forEach(form => form.reset());
        }
        
        // Enhanced toast notification utility
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const messageEl = document.getElementById('toastMessage');
            
            messageEl.textContent = message;
            
            const config = {
                success: { icon: 'fas fa-check-circle text-green-500', border: 'border-green-400' },
                error: { icon: 'fas fa-exclamation-circle text-red-500', border: 'border-red-400' },
                warning: { icon: 'fas fa-exclamation-triangle text-yellow-500', border: 'border-yellow-400' },
                info: { icon: 'fas fa-info-circle text-blue-500', border: 'border-blue-400' }
            };
            
            icon.className = config[type].icon;
            toast.querySelector('div > div').className = `bg-white rounded-lg shadow-lg border-l-4 ${config[type].border} p-4 max-w-sm`;
            
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                hideToast();
            }, 5000);
        }
        
        function hideToast() {
            document.getElementById('toast').classList.add('hidden');
        }
        
        // Auto-refresh dashboard every 30 seconds
        setInterval(loadDashboardStats, 30000);
    </script>
</body>
</html>', () => {
                        document.getElementById('questionInput').value = `Tell me about ${doc.product_name}`;
                        askQuestion();
                    });
                    container.appendChild(div);
                });
                
            } catch (error) {
                console.error('Error loading recent documents:', error);
            }
        }
        
        // Enhanced question asking with auto web search support
        async function askQuestion() {
            const question = document.getElementById('questionInput').value.trim();
            const department = document.getElementById('departmentFilter')?.value;
            const city = document.getElementById('cityFilter')?.value;
            const state = document.getElementById('stateFilter')?.value;
            
            if (!question) {
                showToast('Please enter a question', 'warning');
                return;
            }
            
            // Add user message to chat
            addMessageToChat(question, 'user');
            document.getElementById('questionInput').value = '';
            
            // Show loading with web search capability
            const loadingDiv = addMessageToChat('Searching local database and online if needed...', 'ai', true);
            
            try {
                const response = await fetch('/api/ask-question', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: question,
                        department: department || null,
                        city: city || null,
                        state: state || null
                    })
                });
                
                const result = await response.json();
                
                // Remove loading message
                loadingDiv.remove();
                
                if (result.success) {
                    let answer = result.answer;
                    
                    // Add location context if applicable
                    if (result.location_context) {
                        answer += `\n\n*Filtered by: ${result.location_context}*`;
                    }
                    
                    // Add sources information
                    if (result.sources && result.sources.length > 0) {
                        answer += "\n\n**Sources:**\n" + result.sources.map(s => 
                            `• ${s.product_name} (${s.location}) - ${s.content_source}`
                        ).join('\n');
                    }
                    
                    addMessageToChat(answer, 'ai');
                    
                    // Show confidence indicator
                    if (result.confidence !== undefined) {
                        showConfidence(result.confidence);
                    }
                    
                    // Show web search notification if performed
                    if (result.web_search_performed) {
                        showToast(`🌐 Found "${result.chemical_found}" online and added to database!`, 'success');
                    }
                } else {
                    addMessageToChat(result.answer || 'Sorry, I couldn\'t find an answer to your question.', 'ai');
                }
                
                // Refresh stats after question
                loadDashboardStats();
                loadRecentDocuments();
                
            } catch (error) {
                loadingDiv.remove();
                addMessageToChat('Sorry, there was an error processing your question.', 'ai');
                console.error('Error asking question:', error);
            }
        }
        
        // Show confidence indicator
        function showConfidence(confidence) {
            const indicator = document.getElementById('confidenceIndicator');
            const bar = document.getElementById('confidenceBar');
            const text = document.getElementById('confidenceText');
            
            const percentage = Math.round(confidence * 100);
            text.textContent = `${percentage}%`;
            bar.style.width = `${percentage}%`;
            
            indicator.classList.remove('hidden');
            
            // Hide after 5 seconds
            setTimeout(() => {
                indicator.classList.add('hidden');
            }, 5000);
        }
        
        // Enhanced message adding with better formatting
        function addMessageToChat(message, sender, isLoading = false) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message p-3 rounded-lg ${isLoading ? 'opacity-50' : ''}`;
            
            const senderLabel = sender === 'user' ? 'You' : 'AI Assistant';
            
            // Convert markdown-style formatting to HTML
            const formattedMessage = message
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/🌐/g, '<span class="text-blue-600">🌐</span>')
                .replace(/📄/g, '<span class="text-green-600">📄</span>')
                .replace(/\n/g, '<br>');
            
            messageDiv.innerHTML = `<p><strong>${senderLabel}:</strong> ${formattedMessage}</p>`;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            return messageDiv;
        }
        
        // Handle enhanced file upload
        async function handleFileUpload(e) {
            e.preventDefault();
            
            const formData = new FormData();
            const fileInput = document.getElementById('file-upload');
            const department = document.getElementById('uploadDepartmentSelect').value;
            const city = document.getElementById('uploadCitySelect').value;
            const state = document.getElementById('uploadStateSelect').value;
            const country = e.target.country.value;
            
            if (!fileInput.files[0] || !department || !city || !state) {
                showToast('Please fill in all required fields', 'warning');
                return;
            }
            
            formData.append('file', fileInput.files[0]);
            formData.append('department', department);
            formData.append('city', city);
            formData.append('state', state);
            formData.append('country', country);
            
            const uploadBtn = e.target.querySelector('button[type="submit"]');
            
            // Show loading state
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';
            uploadBtn.disabled = true;
            
            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(`File uploaded successfully: ${result.product_name}`, 'success');
                    hideModal('uploadModal');
                    e.target.reset();
                    loadDashboardStats();
                    loadRecentDocuments();
                } else {
                    showToast(result.message, 'error');
                }
                
            } catch (error) {
                console.error('Error uploading file:', error);
                showToast('Error uploading file', 'error');
            } finally {
                uploadBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>Upload';
                uploadBtn.disabled = false;
            }
        }
        
        // Handle web search for SDS
        async function handleWebSearch(e) {
            e.preventDefault();
            
            const chemicalName = document.getElementById('searchChemicalName').value.trim();
            const department = document.getElementById('searchDepartmentSelect').value;
            const city = document.getElementById('searchCitySelect').value;
            const state = document.getElementById('searchStateSelect').value;
            
            if (!chemicalName || !department || !city || !state) {
                showToast('Please fill in all required fields', 'warning');
                return;
            }
            
            const searchBtn = e.target.querySelector('button[type="submit"]');
            
            // Show loading state
            searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Searching...';
            searchBtn.disabled = true;
            
            try {
                const response = await fetch('/api/search-web-sds', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chemical_name: chemicalName,
                        department: department,
                        city: city,
                        state: state
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(`Found and stored SDS for ${result.product_name}`, 'success');
                    hideModal('webSearchModal');
                    e.target.reset();
                    loadDashboardStats();
                    loadRecentDocuments();
                } else {
                    showToast(result.message, 'error');
                }
                
            } catch (error) {
                console.error('Error searching for SDS:', error);
                showToast('Error searching for SDS', 'error');
            } finally {
                searchBtn.innerHTML = '<i class="fas fa-search mr-2"></i>Search & Download';
                searchBtn.disabled = false;
            }
        }
        
        // Generate label (enhanced with dual options)
        async function generateLabel(type) {
            const productName = document.getElementById('labelProductName').value.trim();
            
            if (!productName) {
                showToast('Please enter a product name', 'warning');
                return;
            }
            
            try {
                const endpoint = type === 'nfpa' ? '/api/generate-nfpa' : '/api/generate-ghs';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ product_name: productName })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(`${result.label_type} label generated successfully`, 'success');
                    hideModal('labelModal');
                    
                    // Create download link
                    const link = document.createElement('a');
                    link.href = `/api/download-label/${result.filename}`;
                    link.download = result.filename;
                    link.click();
                } else {
                    showToast(result.message, 'error');
                }
                
            } catch (error) {
                console.error('Error generating label:', error);
                showToast('Error generating label', 'error');
            }
        }
        
        // Update location filters based on selection
        function updateLocationFilters() {
            const state = document.getElementById('stateFilter').value;
            if (state) {
                loadCitiesByState(state, 'cityFilter');
            } else {
                document.getElementById('cityFilter').innerHTML = '<option value="">All Cities</option>';
            }
        }
        
        // Update popular questions display
        function updatePopularQuestions(questions) {
            const container = document.getElementById('popularQuestions');
            container.innerHTML = '';
            
            if (questions.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No questions asked yet</p>';
                return;
            }
            
            questions.forEach(q => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition';
                div.innerHTML = `
                    <div>
                        <p class="text-sm font-medium">${q.question}</p>
                        <p class="text-xs text-gray-500">${q.count} times asked</p>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                `;
                div.addEventListener('click<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EHS Smart System - SDS Assistant</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover:hover { transform: translateY(-2px); transition: transform 0.3s; }
        .chat-container { max-height: 500px; overflow-y: auto; }
        .message { margin-bottom: 1rem; animation: fadeIn 0.3s ease-in; }
        .user-message { background: #3b82f6; color: white; }
        .ai-message { background: #f3f4f6; color: #374151; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .filter-section { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); }
        .confidence-bar { height: 4px; border-radius: 2px; transition: width 0.5s ease; }
        .web-search-indicator { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Enhanced Navigation -->
    <nav class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-shield-alt text-white text-2xl mr-3"></i>
                    <span class="text-white text-xl font-bold">EHS Smart System</span>
                    <span class="text-white text-sm ml-2 opacity-75">Safety Data Sheet Assistant with Auto Web Search</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="uploadBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-upload mr-2"></i>Upload SDS
                    </button>
                    <button id="generateLabelBtn" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-tags mr-2"></i>Generate Labels
                    </button>
                    <button id="webSearchBtn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-globe mr-2"></i>Web Search
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Enhanced Dashboard Stats -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                        <i class="fas fa-file-alt text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Documents</p>
                        <p id="totalDocs" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                        <i class="fas fa-map-marker-alt text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Active Locations</p>
                        <p id="activeLocations" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                        <i class="fas fa-question-circle text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Questions Answered</p>
                        <p id="recentQuestions" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-red-100 text-red-600">
                        <i class="fas fa-exclamation-triangle text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">High Hazard Materials</p>
                        <p id="hazardousMaterials" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-indigo-100 text-indigo-600">
                        <i class="fas fa-globe text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Web Searches</p>
                        <p id="webSearches" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Enhanced AI Question Answering -->
            <div class="lg:col-span-2 bg-white rounded-lg shadow">
                <div class="p-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">
                        <i class="fas fa-robot mr-2"></i>Ask AI About SDS Documents
                        <span class="text-sm font-normal text-green-600 ml-2">🌐 Auto Web Search Enabled</span>
                    </h2>
                    
                    <!-- Location Filters -->
                    <div class="filter-section p-4 rounded-lg mb-4">
                        <h4 class="font-semibold text-gray-700 mb-3">Filter by Location</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <select id="departmentFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">All Departments</option>
                            </select>
                            <select id="cityFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">All Cities</option>
                            </select>
                            <select id="stateFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">All States</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Chat Container -->
                    <div id="chatContainer" class="chat-container border rounded-lg p-4 mb-4 bg-gray-50">
                        <div class="message ai-message p-3 rounded-lg">
                            <p><strong>AI Assistant:</strong> Hello! I can help you find information in your SDS documents. If I don't have the data locally, I'll automatically search online and store it for you. Try asking:</p>
                            <ul class="mt-2 ml-4 list-disc text-sm">
                                <li>"Tell me about acetone"</li>
                                <li>"What are the first aid measures for cleaner degreaser?"</li>
                                <li>"How should I store bleach in the laboratory?"</li>
                                <li>"What PPE is needed for handling isopropyl alcohol?"</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Question Input -->
                    <div class="flex space-x-2 mb-4">
                        <input 
                            type="text" 
                            id="questionInput" 
                            placeholder="Ask about any chemical (e.g., 'Tell me about acetone' or 'First aid for bleach')"
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        >
                        <button id="askBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    
                    <!-- Quick Questions -->
                    <div class="mb-4">
                        <h4 class="font-semibold text-gray-700 mb-2">Quick Questions:</h4>
                        <div class="flex flex-wrap gap-2">
                            <button class="quick-question bg-blue-100 hover:bg-blue-200 px-3 py-1 rounded-full text-sm transition" data-question="Tell me about acetone">
                                About Acetone
                            </button>
                            <button class="quick-question bg-green-100 hover:bg-green-200 px-3 py-1 rounded-full text-sm transition" data-question="What are the first aid measures for bleach?">
                                Bleach First Aid
                            </button>
                            <button class="quick-question bg-orange-100 hover:bg-orange-200 px-3 py-1 rounded-full text-sm transition" data-question="Tell me about isopropyl alcohol">
                                About Isopropyl Alcohol
                            </button>
                            <button class="quick-question bg-red-100 hover:bg-red-200 px-3 py-1 rounded-full text-sm transition" data-question="What are the fire fighting measures for methanol?">
                                Methanol Fire Safety
                            </button>
                            <button class="quick-question bg-purple-100 hover:bg-purple-200 px-3 py-1 rounded-full text-sm transition" data-question="Tell me about cleaner degreaser">
                                About Cleaner Degreaser
                            </button>
                        </div>
                    </div>
                    
                    <!-- Answer Confidence Indicator -->
                    <div id="confidenceIndicator" class="hidden mb-4">
                        <div class="flex items-center justify-between text-sm text-gray-600 mb-1">
                            <span>Answer Confidence</span>
                            <span id="confidenceText">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="confidenceBar" class="confidence-bar bg-gradient-to-r from-red-400 via-yellow-400 to-green-400" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- Web Search Indicator -->
                    <div id="webSearchIndicator" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                        <div class="flex items-center">
                            <i class="fas fa-globe text-blue-600 text-lg mr-2 web-search-indicator"></i>
                            <span class="text-blue-800 font-medium">Searching online for chemical information...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced File Management & Recent Documents -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">
                        <i class="fas fa-file-upload mr-2"></i>Document Management
                    </h2>
                    
                    <!-- Action Buttons -->
                    <div class="grid grid-cols-1 gap-3 mb-6">
                        <button id="uploadDocBtn" class="bg-blue-100 hover:bg-blue-200 p-4 rounded-lg transition text-center">
                            <i class="fas fa-upload text-blue-600 text-xl mb-2"></i>
                            <h3 class="font-semibold text-blue-600">Upload SDS File</h3>
                            <p class="text-xs text-gray-600">PDF, TXT, DOC files</p>
                        </button>
                        
                        <button id="webSearchDocBtn" class="bg-purple-100 hover:bg-purple-200 p-4 rounded-lg transition text-center">
                            <i class="fas fa-globe text-purple-600 text-xl mb-2"></i>
                            <h3 class="font-semibold text-purple-600">Search Web for SDS</h3>
                            <p class="text-xs text-gray-600">Find SDS online</p>
                        </button>
                        
                        <button id="generateLabelsBtn" class="bg-orange-100 hover:bg-orange-200 p-4 rounded-lg transition text-center">
                            <i class="fas fa-tags text-orange-600 text-xl mb-2"></i>
                            <h3 class="font-semibold text-orange-600">Generate Labels</h3>
                            <p class="text-xs text-gray-600">NFPA & GHS labels</p>
                        </button>
                    </div>
                    
                    <!-- Recent Documents -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Recent Documents</h4>
                        <div id="recentDocumentsList" class="space-y-2 max-h-64 overflow-y-auto">
                            <p class="text-gray-500 text-center py-4">No documents uploaded yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Analytics Section -->
        <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Popular Questions -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-6">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">
                        <i class="fas fa-chart-line mr-2"></i>Popular Questions
                    </h3>
                    <div id="popularQuestions" class="space-y-3">
                        <p class="text-gray-500 text-center py-4">No questions asked yet</p>
                    </div>
                </div>
            </div>
            
            <!-- Top Departments -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-6">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">
                        <i class="fas fa-building mr-2"></i>Top Departments
                    </h3>
                    <div id="topDepartments" class="space-y-3">
                        <p class="text-gray-500 text-center py-4">No data available yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Upload Modal -->
    <div id="uploadModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-lg w-full">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-900">Upload SDS Document</h3>
                        <button id="closeUploadModal" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap
