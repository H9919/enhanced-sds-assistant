<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDS Assistant - AI-Powered Safety Data Sheet Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover:hover { transform: translateY(-2px); transition: transform 0.2s; }
        .chat-container { max-height: 400px; overflow-y: auto; }
        .message { margin-bottom: 1rem; }
        .user-message { background: #3b82f6; color: white; }
        .ai-message { background: #f3f4f6; color: #374151; }
        .web-result { border-left: 4px solid #10b981; background: #ecfdf5; }
        .local-result { border-left: 4px solid #3b82f6; background: #eff6ff; }
        .loading-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .ghs-option { 
            border: 2px solid #e5e7eb; 
            border-radius: 8px; 
            padding: 12px; 
            cursor: pointer; 
            transition: all 0.2s;
        }
        .ghs-option:hover { border-color: #3b82f6; background: #f8fafc; }
        .ghs-option.selected { border-color: #3b82f6; background: #eff6ff; }
        
        .pictogram-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .pictogram-item {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .pictogram-item:hover { background: #f3f4f6; }
        .pictogram-item.selected { background: #dbeafe; border-color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-flask text-white text-2xl mr-3"></i>
                    <span class="text-white text-xl font-bold">SDS Assistant</span>
                    <span class="text-white text-sm ml-2 opacity-75">AI-Powered Safety Data Sheet Management</span>
                    <span class="bg-green-500 text-white text-xs px-2 py-1 rounded-full ml-3">Web Search Enabled</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="uploadBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-upload mr-2"></i>Upload SDS
                    </button>
                    <div class="relative">
                        <button id="generateStickerBtn" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition">
                            <i class="fas fa-tag mr-2"></i>Generate Sticker
                        </button>
                        <div id="stickerDropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10 hidden">
                            <button id="generateNFPAQuick" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-diamond mr-2 text-red-500"></i>NFPA Diamond
                            </button>
                            <button id="generateGHSQuick" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-exclamation-triangle mr-2 text-orange-500"></i>GHS Label
                            </button>
                            <button id="generateGHSCustom" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-cog mr-2 text-blue-500"></i>Custom GHS Label
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Dashboard Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                        <i class="fas fa-file-alt text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Documents</p>
                        <p id="totalDocs" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                        <i class="fas fa-map-marker-alt text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Active Locations</p>
                        <p id="activeLocations" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                        <i class="fas fa-question-circle text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Recent Questions</p>
                        <p id="recentQuestions" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-orange-100 text-orange-600">
                        <i class="fas fa-globe text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Web Searches</p>
                        <p id="webSearches" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- AI Question Answering -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">
                        <i class="fas fa-robot mr-2"></i>Ask AI About SDS Documents
                        <span class="text-sm font-normal text-green-600 ml-2">
                            <i class="fas fa-wifi mr-1"></i>Web Search Active
                        </span>
                    </h2>
                    
                    <div class="mb-4">
                        <select id="locationFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">All Locations</option>
                        </select>
                    </div>
                    
                    <div id="chatContainer" class="chat-container border rounded-lg p-4 mb-4 bg-gray-50">
                        <div class="message ai-message p-3 rounded-lg local-result">
                            <p><strong>AI Assistant:</strong> Hello! I can help you find information in your SDS documents and search the web for additional safety information. Try asking questions like:</p>
                            <ul class="mt-2 ml-4 list-disc text-sm">
                                <li>"What are the first aid measures for acetone?"</li>
                                <li>"How should I store bleach safely?"</li>
                                <li>"What PPE is needed for handling sulfuric acid?"</li>
                                <li>"What are the fire fighting measures for methanol?"</li>
                            </ul>
                            <p class="text-xs text-green-600 mt-2">
                                <i class="fas fa-info-circle mr-1"></i>
                                If I can't find information in your documents, I'll automatically search the web for additional safety data.
                            </p>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2">
                        <input 
                            type="text" 
                            id="questionInput" 
                            placeholder="Ask a question about chemical safety..."
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        >
                        <button id="askBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    
                    <div class="mt-4">
                        <h4 class="font-semibold text-gray-700 mb-2">Quick Questions:</h4>
                        <div class="flex flex-wrap gap-2">
                            <button class="quick-question bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-full text-sm transition" data-question="What are the first aid measures for this chemical?">
                                First Aid
                            </button>
                            <button class="quick-question bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-full text-sm transition" data-question="How should this chemical be stored safely?">
                                Storage
                            </button>
                            <button class="quick-question bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-full text-sm transition" data-question="What PPE is required for handling this chemical?">
                                PPE Requirements
                            </button>
                            <button class="quick-question bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-full text-sm transition" data-question="What are the fire fighting measures for this chemical?">
                                Fire Fighting
                            </button>
                            <button class="quick-question bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-full text-sm transition" data-question="What are the health hazards of this chemical?">
                                Health Hazards
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- File Upload & Management -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">
                        <i class="fas fa-cloud-upload-alt mr-2"></i>Document Management
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <button id="uploadDocBtn" class="bg-blue-100 hover:bg-blue-200 p-4 rounded-lg transition text-center">
                            <i class="fas fa-upload text-blue-600 text-2xl mb-2"></i>
                            <h3 class="font-semibold">Upload SDS File</h3>
                            <p class="text-sm text-gray-600">PDF, TXT, DOC files</p>
                        </button>
                        
                        <button id="webSearchInfo" class="bg-green-100 hover:bg-green-200 p-4 rounded-lg transition text-center">
                            <i class="fas fa-globe text-green-600 text-2xl mb-2"></i>
                            <h3 class="font-semibold">Auto Web Search</h3>
                            <p class="text-sm text-gray-600">Automatic when needed</p>
                        </button>
                    </div>
                    
                    <div id="recentDocuments">
                        <h4 class="font-semibold text-gray-700 mb-3">Recent Documents</h4>
                        <div id="documentsList" class="space-y-2">
                            <p class="text-gray-500 text-center py-4">No documents uploaded yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Popular Questions -->
        <div class="mt-8 bg-white rounded-lg shadow">
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4">Popular Questions</h3>
                <div id="popularQuestions" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <p class="text-gray-500 text-center py-4 col-span-2">No questions asked yet</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-900">Upload SDS Document</h3>
                        <button id="closeUploadModal" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
                            <select id="uploadStateSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                <option value="">Choose a state...</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                            <select id="uploadLocationSelect" name="location_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                <option value="">Choose a location...</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">SDS File</label>
                            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg hover:border-gray-400 transition">
                                <div class="space-y-1 text-center">
                                    <i class="fas fa-cloud-upload-alt text-3xl text-gray-400"></i>
                                    <div class="flex text-sm text-gray-600">
                                        <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500">
                                            <span>Upload a file</span>
                                            <input id="file-upload" name="file" type="file" class="sr-only" accept=".pdf,.txt,.doc,.docx" required>
                                        </label>
                                        <p class="pl-1">or drag and drop</p>
                                    </div>
                                    <p class="text-xs text-gray-500">PDF, TXT, DOC up to 50MB</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button type="button" id="cancelUpload" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">
                                Cancel
                            </button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                <i class="fas fa-upload mr-2"></i>Upload
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced GHS Modal -->
    <div id="ghsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-900">Generate GHS Label</h3>
                        <button id="closeGHSModal" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- GHS Generation Options -->
                    <div class="mb-6">
                        <h4 class="font-medium text-gray-700 mb-3">Choose Generation Method:</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="ghs-option" data-option="auto">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-magic text-blue-500 mr-2"></i>
                                    <span class="font-medium">Auto Generate</span>
                                </div>
                                <p class="text-sm text-gray-600">Use existing SDS data</p>
                            </div>
                            <div class="ghs-option" data-option="custom">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-cog text-green-500 mr-2"></i>
                                    <span class="font-medium">Custom Options</span>
                                </div>
                                <p class="text-sm text-gray-600">Specify your own GHS data</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Product Name -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Product Name</label>
                        <input type="text" id="ghsProductName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Enter product name...">
                    </div>
                    
                    <!-- Custom GHS Options (initially hidden) -->
                    <div id="customGHSOptions" class="hidden">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Signal Word</label>
                            <select id="ghsSignalWord" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="DANGER">DANGER</option>
                                <option value="WARNING" selected>WARNING</option>
                                <option value="CAUTION">CAUTION</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hazard Pictograms</label>
                            <div class="pictogram-selector">
                                <div class="pictogram-item" data-pictogram="explosive">
                                    <div class="text-2xl">üí•</div>
                                    <div class="text-xs">Explosive</div>
                                </div>
                                <div class="pictogram-item" data-pictogram="flammable">
                                    <div class="text-2xl">üî•</div>
                                    <div class="text-xs">Flammable</div>
                                </div>
                                <div class="pictogram-item" data-pictogram="toxic">
                                    <div class="text-2xl">‚ò†Ô∏è</div>
                                    <div class="text-xs">Toxic</div>
                                </div>
                                <div class="pictogram-item" data-pictogram="corrosive">
                                    <div class="text-2xl">‚ö†Ô∏è</div>
                                    <div class="text-xs">Corrosive</div>
                                </div>
                                <div class="pictogram-item" data-pictogram="environmental">
                                    <div class="text-2xl">üêü</div>
                                    <div class="text-xs">Environmental</div>
                                </div>
                                <div class="pictogram-item" data-pictogram="health hazard">
                                    <div class="text-2xl">‚ö†Ô∏è</div>
                                    <div class="text-xs">Health Hazard</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hazard Statements</label>
                            <textarea id="ghsHazardStatements" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Enter hazard statements..."></textarea>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Precautionary Statements</label>
                            <textarea id="ghsPrecautionaryStatements" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Enter precautionary statements..."></textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancelGHS" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">
                            Cancel
                        </button>
                        <button id="generateGHSFinal" type="button" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition">
                            <i class="fas fa-exclamation-triangle mr-2"></i>Generate GHS Label
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Simple Sticker Modal -->
    <div id="stickerModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-900">Generate Safety Sticker</h3>
                        <button id="closeStickerModal" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Product Name</label>
                        <input type="text" id="stickerProductName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Enter product name...">
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancelSticker" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">
                            Cancel
                        </button>
                        <button id="generateNFPA" type="button" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                            <i class="fas fa-diamond mr-2"></i>NFPA Diamond
                        </button>
                        <button id="generateGHS" type="button" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition">
                            <i class="fas fa-exclamation-triangle mr-2"></i>GHS Label
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" class="fixed top-4 right-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg border-l-4 p-4 max-w-sm">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i id="toastIcon" class="text-xl"></i>
                </div>
                <div class="ml-3">
                    <p id="toastMessage" class="text-sm font-medium text-gray-900"></p>
                </div>
                <div class="ml-auto pl-3">
                    <button id="closeToast" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentConversation = [];
        let selectedGHSOption = 'auto';
        let selectedPictograms = [];
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardStats();
            loadStates();
            loadLocations();
            setupEventListeners();
        });
        
        // Setup event listeners
        function setupEventListeners() {
            // Question answering
            document.getElementById('askBtn').addEventListener('click', askQuestion);
            document.getElementById('questionInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') askQuestion();
            });
            
            // Quick questions
            document.querySelectorAll('.quick-question').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.getElementById('questionInput').value = this.dataset.question;
                    askQuestion();
                });
            });
            
            // File upload
            document.getElementById('uploadBtn').addEventListener('click', () => showModal('uploadModal'));
            document.getElementById('uploadDocBtn').addEventListener('click', () => showModal('uploadModal'));
            document.getElementById('closeUploadModal').addEventListener('click', () => hideModal('uploadModal'));
            document.getElementById('cancelUpload').addEventListener('click', () => hideModal('uploadModal'));
            document.getElementById('uploadForm').addEventListener('submit', handleFileUpload);
            
            // Sticker generation dropdown
            document.getElementById('generateStickerBtn').addEventListener('click', function(e) {
                e.stopPropagation();
                const dropdown = document.getElementById('stickerDropdown');
                dropdown.classList.toggle('hidden');
            });
            
            // Hide dropdown when clicking outside
            document.addEventListener('click', function() {
                document.getElementById('stickerDropdown').classList.add('hidden');
            });
            
            // Dropdown options
            document.getElementById('generateNFPAQuick').addEventListener('click', () => {
                document.getElementById('stickerDropdown').classList.add('hidden');
                showModal('stickerModal');
            });
            document.getElementById('generateGHSQuick').addEventListener('click', () => {
                document.getElementById('stickerDropdown').classList.add('hidden');
                showModal('stickerModal');
            });
            document.getElementById('generateGHSCustom').addEventListener('click', () => {
                document.getElementById('stickerDropdown').classList.add('hidden');
                showModal('ghsModal');
            });
            
            // Simple sticker modal
            document.getElementById('closeStickerModal').addEventListener('click', () => hideModal('stickerModal'));
            document.getElementById('cancelSticker').addEventListener('click', () => hideModal('stickerModal'));
            document.getElementById('generateNFPA').addEventListener('click', () => generateSticker('nfpa'));
            document.getElementById('generateGHS').addEventListener('click', () => generateSticker('ghs'));
            
            // Enhanced GHS modal
            document.getElementById('closeGHSModal').addEventListener('click', () => hideModal('ghsModal'));
            document.getElementById('cancelGHS').addEventListener('click', () => hideModal('ghsModal'));
            document.getElementById('generateGHSFinal').addEventListener('click', generateEnhancedGHS);
            
            // GHS option selection
            document.querySelectorAll('.ghs-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.ghs-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedGHSOption = this.dataset.option;
                    
                    const customOptions = document.getElementById('customGHSOptions');
                    if (selectedGHSOption === 'custom') {
                        customOptions.classList.remove('hidden');
                    } else {
                        customOptions.classList.add('hidden');
                    }
                });
            });
            
            // Pictogram selection
            document.querySelectorAll('.pictogram-item').forEach(item => {
                item.addEventListener('click', function() {
                    const pictogram = this.dataset.pictogram;
                    if (this.classList.contains('selected')) {
                        this.classList.remove('selected');
                        selectedPictograms = selectedPictograms.filter(p => p !== pictogram);
                    } else {
                        this.classList.add('selected');
                        selectedPictograms.push(pictogram);
                    }
                });
            });
            
            // State/Location handling
            document.getElementById('uploadStateSelect').addEventListener('change', function() {
                loadLocationsByState(this.value, 'uploadLocationSelect');
            });
            
            // Web search info
            document.getElementById('webSearchInfo').addEventListener('click', function() {
                showToast('Web search is automatically activated when local SDS documents don\'t contain the information you need!', 'info');
            });
            
            // Toast close
            document.getElementById('closeToast').addEventListener('click', hideToast);
        }
        
        // Load dashboard statistics
        async function loadDashboardStats() {
            try {
                const response = await fetch('/api/dashboard-stats');
                const stats = await response.json();
                
                document.getElementById('totalDocs').textContent = stats.total_documents;
                document.getElementById('activeLocations').textContent = stats.active_locations;
                document.getElementById('recentQuestions').textContent = stats.recent_questions;
                document.getElementById('webSearches').textContent = stats.web_searches || 0;
                
                updatePopularQuestions(stats.popular_questions);
                
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }
        
        // Load states
        async function loadStates() {
            try {
                const response = await fetch('/api/states');
                const states = await response.json();
                
                const select = document.getElementById('uploadStateSelect');
                states.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading states:', error);
            }
        }
        
        // Load locations
        async function loadLocations() {
            try {
                const response = await fetch('/api/locations');
                const locations = await response.json();
                
                const select = document.getElementById('locationFilter');
                locations.slice(0, 50).forEach(location => {
                    const option = document.createElement('option');
                    option.value = location.id;
                    option.textContent = location.display_name;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading locations:', error);
            }
        }
        
        // Load locations by state
        async function loadLocationsByState(state, selectId) {
            if (!state) {
                document.getElementById(selectId).innerHTML = '<option value="">Choose a location...</option>';
                return;
            }
            
            try {
                const response = await fetch(`/api/locations?state=${encodeURIComponent(state)}`);
                const locations = await response.json();
                
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Choose a location...</option>';
                
                locations.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location.id;
                    option.textContent = location.display_name;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading locations:', error);
            }
        }
        
        // Enhanced ask question with web search support
        async function askQuestion() {
            const question = document.getElementById('questionInput').value.trim();
            const locationId = document.getElementById('locationFilter').value;
            
            if (!question) {
                showToast('Please enter a question', 'warning');
                return;
            }
            
            // Add user message to chat
            addMessageToChat(question, 'user');
            document.getElementById('questionInput').value = '';
            
            // Show loading with web search indicator
            const loadingDiv = addMessageToChat('üîç Searching your SDS documents and the web...', 'ai', true);
            
            try {
                const response = await fetch('/api/ask-question-enhanced', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: question,
                        location_id: locationId || null
                    })
                });
                
                const result = await response.json();
                
                // Remove loading message
                loadingDiv.remove();
                
                if (result.success) {
                    let answer = result.answer;
                    let messageClass = 'ai-message';
                    
                    // Determine if web results were used
                    if (result.has_web_results) {
                        messageClass += ' web-result';
                        answer = 'üåê ' + answer;
                    } else {
                        messageClass += ' local-result';
                        answer = 'üìÑ ' + answer;
                    }
                    
                    // Add sources information
                    if (result.sources && result.sources.length > 0) {
                        const localSources = result.sources.filter(s => s.type !== 'web');
                        const webSources = result.sources.filter(s => s.type === 'web');
                        
                        if (localSources.length > 0) {
                            answer += "\n\nüìã Local Sources: " + localSources.map(s => s.product_name || s.url).join(', ');
                        }
                        if (webSources.length > 0) {
                            answer += "\n\nüîó Web Sources: " + webSources.map(s => s.url).join(', ');
                        }
                    }
                    
                    // Add confidence indicator
                    const confidence = Math.round((result.confidence || 0) * 100);
                    answer += `\n\nüéØ Confidence: ${confidence}%`;
                    
                    addMessageToChat(answer, 'ai', false, messageClass);
                } else {
                    addMessageToChat(result.answer || 'Sorry, I couldn\'t find an answer to your question.', 'ai');
                }
                
                // Update dashboard stats
                loadDashboardStats();
                
            } catch (error) {
                loadingDiv.remove();
                addMessageToChat('Sorry, there was an error processing your question.', 'ai');
                console.error('Error asking question:', error);
            }
        }
        
        // Enhanced add message to chat
        function addMessageToChat(message, sender, isLoading = false, customClass = '') {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            
            let messageClass = `message ${sender}-message p-3 rounded-lg ${isLoading ? 'opacity-50' : ''}`;
            if (customClass) {
                messageClass = `message p-3 rounded-lg ${customClass} ${isLoading ? 'opacity-50' : ''}`;
            }
            
            messageDiv.className = messageClass;
            
            const senderLabel = sender === 'user' ? 'You' : 'AI Assistant';
            messageDiv.innerHTML = `<p><strong>${senderLabel}:</strong> ${message.replace(/\n/g, '<br>')}</p>`;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            return messageDiv;
        }
        
        // Handle file upload
        async function handleFileUpload(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const uploadBtn = e.target.querySelector('button[type="submit"]');
            
            // Show loading state
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';
            uploadBtn.disabled = true;
            
            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(`File uploaded successfully: ${result.product_name}`, 'success');
                    hideModal('uploadModal');
                    e.target.reset();
                    loadDashboardStats();
                } else {
                    showToast(result.message, 'error');
                }
                
            } catch (error) {
                console.error('Error uploading file:', error);
                showToast('Error uploading file', 'error');
            } finally {
                uploadBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>Upload';
                uploadBtn.disabled = false;
            }
        }
        
        // Generate simple sticker
        async function generateSticker(type) {
            const productName = document.getElementById('stickerProductName').value.trim();
            
            if (!productName) {
                showToast('Please enter a product name', 'warning');
                return;
            }
            
            try {
                const endpoint = type === 'nfpa' ? '/api/generate-nfpa' : '/api/generate-ghs';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ product_name: productName })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(`${result.sticker_type} sticker generated successfully`, 'success');
                    hideModal('stickerModal');
                    
                    // Create download link
                    const link = document.createElement('a');
                    link.href = `/api/download-sticker/${result.filename}`;
                    link.download = result.filename;
                    link.click();
                } else {
                    showToast(result.message, 'error');
                }
                
            } catch (error) {
                console.error('Error generating sticker:', error);
                showToast('Error generating sticker', 'error');
            }
        }
        
        // Generate enhanced GHS sticker
        async function generateEnhancedGHS() {
            const productName = document.getElementById('ghsProductName').value.trim();
            
            if (!productName) {
                showToast('Please enter a product name', 'warning');
                return;
            }
            
            let requestData = { product_name: productName };
            
            if (selectedGHSOption === 'custom') {
                const customData = {
                    signal_word: document.getElementById('ghsSignalWord').value,
                    pictograms: selectedPictograms.join(', '),
                    hazard_statements: document.getElementById('ghsHazardStatements').value,
                    precautionary_statements: document.getElementById('ghsPrecautionaryStatements').value
                };
                requestData.custom_data = customData;
            }
            
            try {
                const response = await fetch('/api/generate-ghs-enhanced', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Enhanced GHS label generated successfully', 'success');
                    hideModal('ghsModal');
                    
                    // Create download link
                    const link = document.createElement('a');
                    link.href = `/api/download-sticker/${result.filename}`;
                    link.download = result.filename;
                    link.click();
                    
                    // Reset form
                    resetGHSForm();
                } else {
                    showToast(result.message, 'error');
                }
                
            } catch (error) {
                console.error('Error generating enhanced GHS sticker:', error);
                showToast('Error generating enhanced GHS sticker', 'error');
            }
        }
        
        // Reset GHS form
        function resetGHSForm() {
            document.getElementById('ghsProductName').value = '';
            document.getElementById('ghsSignalWord').value = 'WARNING';
            document.getElementById('ghsHazardStatements').value = '';
            document.getElementById('ghsPrecautionaryStatements').value = '';
            selectedPictograms = [];
            document.querySelectorAll('.pictogram-item').forEach(item => item.classList.remove('selected'));
            document.querySelectorAll('.ghs-option').forEach(opt => opt.classList.remove('selected'));
            document.getElementById('customGHSOptions').classList.add('hidden');
            selectedGHSOption = 'auto';
        }
        
        // Update popular questions
        function updatePopularQuestions(questions) {
            const container = document.getElementById('popularQuestions');
            container.innerHTML = '';
            
            if (questions.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4 col-span-2">No questions asked yet</p>';
                return;
            }
            
            questions.forEach(q => {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 p-3 rounded-lg cursor-pointer hover:bg-gray-100 transition';
                div.innerHTML = `
                    <p class="text-sm font-medium">${q.question}</p>
                    <p class="text-xs text-gray-500">${q.count} times asked</p>
                `;
                div.addEventListener('click', () => {
                    document.getElementById('questionInput').value = q.question;
                    askQuestion();
                });
                container.appendChild(div);
            });
        }
        
        // Modal utilities
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            if (modalId === 'uploadModal') {
                loadStates();
            } else if (modalId === 'ghsModal') {
                resetGHSForm();
                // Auto-select first option
                document.querySelector('.ghs-option[data-option="auto"]').classList.add('selected');
            }
        }
        
        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }
        
        // Toast notification utility
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const messageEl = document.getElementById('toastMessage');
            
            messageEl.textContent = message;
            
            const config = {
                success: { icon: 'fas fa-check-circle text-green-500', border: 'border-green-400' },
                error: { icon: 'fas fa-exclamation-circle text-red-500', border: 'border-red-400' },
                warning: { icon: 'fas fa-exclamation-triangle text-yellow-500', border: 'border-yellow-400' },
                info: { icon: 'fas fa-info-circle text-blue-500', border: 'border-blue-400' }
            };
            
            icon.className = config[type].icon;
            toast.querySelector('div > div').className = `bg-white rounded-lg shadow-lg border-l-4 ${config[type].border} p-4 max-w-sm`;
            
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                hideToast();
            }, 5000);
        }
        
        function hideToast() {
            document.getElementById('toast').classList.add('hidden');
        }
    </script>
</body>
</html>
